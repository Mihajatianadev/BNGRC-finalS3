FONCTIONNALITES EXISTANTES (état actuel du projet)

1) Routing / Framework
- Application PHP basée sur Flight (mikecao/flight).
- Point d'entrée: public/index.php
- Bootstrap: app/bootstrap.php (PDO + views path + routes)

2) Base de données
- Script: database/base.sql
- Tables: roles, users, regions, villes, categories, produits, stock, dons, demandes, distributions, achats
- Tables (extension stock/vente): remise, ventes
- Colonnes de reset: isDefault sur dons/demandes/distributions/achats
- Vues: vue_demandes_detaillees, vue_stock_detaille, vue_demandes_en_attente, vue_demandes_par_region, vue_achats_par_ville, vue_dons_argent

3) Pages / Views
- app/views/auth/register.php
- app/views/auth/accueil.php
- app/views/login.php
- Admin (app/views/admin/*):
  - Voir_tout_admin.php
  - dashboard.php
  - achats.php
  - recapitulatif.php (AJAX)
  - stock.php (vente)
  - don-argent-saisie.php
  - prix.php
  - ventes.php
  - _navbar.php (sidebar unifiée)
  - footer.php (pied de page)

4) Controllers
- AuthController:
  - showLogin(): affiche la page login
  - postLogin(): authentifie et crée la session
  - logout(): détruit la session
  - showRegister/postRegister/validateRegisterAjax(): inscription (à maintenir cohérente avec le schéma users)
- ObjetController: pages publiques (accueil, contacts, actualités)
- AdminController:
  - voirTout(): page de synthèse + filtres (ville/date)
  - dashboard(): dashboard demandes + filtres région/ville
  - achats(): liste des achats + filtres (ville/date)
  - stock(): affichage stock
- RecapController:
  - showRecap(): affiche recapitulatif
  - getRecapJson(): API JSON filtrable (ville/date)
- DonController:
  - postDonGlobal(): ajout don global au stock
  - postDonArgent(): don en argent affecté à une ville
  - resetDons(): reset complet (non-default) + recalcul stock
- StockController:
  - index(): liste stocks + remise/prix
  - vendre(): enregistre une vente + décrémente stock
- PrixController:
  - index(): liste produits + prix_unitaire
  - update(): mise à jour du prix unitaire d'un produit

5) Repositories / Services
- UserRepository + UserService + Validator (inscription)
- ObjetRepository (liste objets + image)
- AuthService: connexion/déconnexion + session id_user/id_role
- DemandeRepository: régions/villes/categories + dashboard + stock détaillé
- AchatRepository: listing achats + filtres
- RecapRepository: calculs récapitulatif (par ville/région/total) + filtres ville/date
- DonRepository: création don + création produit/catégorie si besoin + MAJ stock
- DonArgentRepository: ajout don argent + MAJ stock "Argent"
- VenteRepository: gestion ventes + remises + MAJ stock + listing ventes
- ProduitRepository: listing produits + mise à jour prix_unitaire

6) Modifications / Ajouts réalisés (détaillé)

6.1) Session (modifié)
- Fichier: app/bootstrap.php
- Changement: ajout de session_start() au début du bootstrap.
- But: permettre la persistance d'un utilisateur connecté via $_SESSION (nécessaire pour l'accès admin).

6.2) Authentification (ajouté)

Pages / Views (ajouté)
- Fichier: app/views/login.php
- URL: /login (GET)
- Fonctionnalité:
  - Accès simplifié: bouton "COMMENCER" qui soumet automatiquement admin@test.com / admin123 (inputs hidden)
  - Affichage d'un message d'erreur global si identifiants invalides

Contrôleur (modifié)
- Fichier: app/controllers/AuthController.php
- Méthodes ajoutées:
  - showLogin(): affiche la view login
  - postLogin(): traite le formulaire login
  - logout(): déconnecte l'utilisateur

Service (ajouté)
- Fichier: app/services/AuthService.php
- Méthodes:
  - connecter($email, $mot_de_passe)
    - Lit l'utilisateur dans la table users via email
    - Vérifie mot_de_passe
      - compatible mot de passe en clair (base.sql) OU hashé (password_verify)
    - Stocke en session:
      - $_SESSION['id_user']
      - $_SESSION['id_role']
  - deconnecter(): supprime id_user et id_role de la session

Routes (modifié)
- Fichier: app/routes.php
- Routes ajoutées:
  - GET /login  -> AuthController::showLogin
  - POST /login -> AuthController::postLogin
  - GET /logout -> AuthController::logout

Flux de navigation (résumé)
- Utilisateur visite /login
- Si authentification OK:
  - si id_role == 2 (ADMIN) => redirection vers /admin/dashboard
  - sinon => redirection vers /accueil

6.3) Dashboard Admin des demandes (ajouté)

Routes (modifié)
- Fichier: app/routes.php
- Route ajoutée:
  - GET /admin/dashboard -> AdminController::dashboard

Contrôleur (ajouté)
- Fichier: app/controllers/AdminController.php
- Fonctionnalités:
  - Vérifie l'accès ADMIN via la session:
    - exige $_SESSION['id_user']
    - lit users.id_role dans la base
    - autorise seulement id_role == 2
  - Charge les données du dashboard via DemandeRepository
  - Envoie les variables à la view admin-dashboard

Repository (ajouté)
- Fichier: app/repositories/DemandeRepository.php
- Méthodes:
  - listeRegions(): liste des régions pour le filtre
  - listeVillesParRegion($id_region): liste des villes selon la région
  - listeDemandesPourDashboard($id_region, $id_ville):
    - Affiche les demandes sous forme agrégée
    - Filtrage optionnel:
      - par région
      - puis par ville
    - Calcul "Nombre de produits demandés" PAR DEMANDE:
      - COUNT(DISTINCT d.id_produit)
      - groupé par (ville + date_demande + statut)
      - permet d'avoir plusieurs demandes pour une même ville (lignes séparées)

View (ajouté)
- Fichier: app/views/admin-dashboard.php
- Fonctionnalités:
  - Formulaire GET avec 2 filtres:
    - Région (active)
    - Ville (désactivé tant qu'aucune région n'est choisie)
  - Affichage des demandes en cards horizontales:
    - à gauche: VILLE
    - à droite: nombre_produits
  - Infos secondaires affichées (petit texte): région/date/statut

CSS (ajouté)
- Fichier: public/css/admin-dashboard.css
- Rôle: styles simples (fond + arrondi cartes)

6.9) Stock + Ventes + Remises
- URL: /admin/stock
- Liste du stock détaillé (catégorie/produit/unité/quantité/prix/remise)
- Vente (POST /admin/vente):
  - Vérifie disponibilité stock
  - Applique remise par catégorie (table remise)
  - Enregistre dans ventes
  - Décrémente le stock
- Historique: /admin/ventes

6.10) Paramétrage des prix
- URL: /admin/prix
- Update prix: POST /admin/prix/update
- Modifie produits.prix_unitaire

6.11) Don en argent (ville)
- URL: /admin/don-argent (GET/POST)
- Enregistre un don de type Argent affecté à une ville (utile pour le recap)

7) Remarques techniques (important pour le groupe)
- Le script database/base.sql définit users avec les colonnes: (id_user, nom, email, mot_de_passe, id_role, date_creation).
- Certaines parties "inscription" existantes (UserRepository/UserService/Validator + register.php) ne correspondent pas encore à ce schéma et peuvent nécessiter une harmonisation.
- Le fichier public/.htaccess contient encore un RewriteBase hérité ("flight-mvc-validation-skeleton"). Selon l'emplacement réel du projet sur Apache, cela peut nécessiter un ajustement.
